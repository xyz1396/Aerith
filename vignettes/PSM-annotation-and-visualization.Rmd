---
title: "PSM-annotation-and-visualization"
output:
  rmarkdown::html_document:
    toc: true
    toc_float: true
    theme: united
vignette: >
  %\VignetteIndexEntry{PSM-annotation-and-visualization}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 10
)
```

```{r setup}
library(Aerith)
library(dplyr)
library(stringr)
library(ggplot2)
```

```{r, include = FALSE, eval=FALSE}
rmarkdown::render("PSM-annotation-and-visualization.Rmd", output_dir = "../doc/")
```

### Unlabeled PSM at 1.07% ^13^C 

#### Annotate B and Y ion fragments

```{r}
psm <- readPSMtsv("../rmd/input data format/pct1.psm.txt")
psm <- arrange(psm, desc(Score))
psm1 <- psm[8, ]
pep <- psm1$OriginalPeptide
pep <- str_sub(pep, 2, -2)
scan1 <- readOneScanMS2("../rmd/input data format/ft/Pan_062822_X1iso5.FT2", psm1$ScanNumber)
scan1 <- getRealScanFromList(scan1)
```

```{r}
isoCenter <- psm1$MeasuredParentMass / psm1$ParentCharge + 1.007276
anno <- annotatePSM(
  scan1@spectra$MZ, scan1@spectra$Prob,
  scan1@spectra$Charge,
  pep, 1:2, "C13",
  0.0107, isoCenter, 5.0
)
tb <- head(anno$ExpectedBYions[anno$ExpectedBYions$matchedIndices != -1, ])
knitr::kable(tb)
residuePos <- anno$ExpectedBYions$residuePositions[anno$ExpectedBYions$matchedIndices != -1]
table(residuePos)
# let the color be repeatable
set.seed(9527)
plotPSMannotation(
  observedSpect = scan1,
  pep = pep, Atom = "C13", Prob = 0.0107,
  charges = c(1, 2), isoCenter = isoCenter,
  isoWidth = 5, ifRemoveNotFoundIon = T
)
```

#### plot fragments and precursor

```{r}
# plot observed fragments peaks and theoretical B and Y ion isotopic peaks
BY <- getSipBYionSpectra(pep, Prob = 0.0107, charges = 1:2, precursorCharges = 3)
plot(BY) + plotRealScan(scan1) + plotSipBYionLabel(BY)
```

```{r}
ft1 <- readScansMS1("../rmd/input data format/ft/Pan_062822_X1iso5.FT1", 3500, 3890)
precursorScan1 <- getRealScan(3885, ft1)

# plot observed precursor peaks and theoretical precursor isotopic peaks
# precursorSP <- getSipPrecursorSpectra(pep, Prob = 0.012, charges = 3)
precursorSP <- getSipPrecursorSpectra(pep, Prob = 0.0107, charges = 3)
precursorSP@spectra$Kind <- "Expected"
xlimit <- precursorScan1@spectra$MZ > 580 & precursorScan1@spectra$MZ < 600
precursorScan1@spectra <- precursorScan1@spectra[xlimit, ]
precursorScan1@spectra$Kind <- "Observed"
maxInt <- max(precursorScan1@spectra$Prob)
precursorScan1@spectra$Prob <- precursorScan1@spectra$Prob / maxInt * 100
plot(precursorSP, linewidth = 0.3) + plotRealScan(precursorScan1, linewidth = 0.3) +
  scale_x_continuous(breaks = seq(580, 600, by = 5))
```



### Labeled PSM at 50% ^13^C 

#### Annotate B and Y ion fragments

```{r}
psm <- readPSMtsv("../rmd/input data format/pct50.psm.txt")
psm <- arrange(psm, desc(Score))
# use the same peptide as 1% 13C chunk
psm1 <- psm[4, ]
pep <- psm1$OriginalPeptide
pep <- str_sub(pep, 2, -2)
pct <- psm1$SearchName
pct <- as.numeric(str_sub(pct, 5, -4)) / 1000 / 100
scan1 <- readOneScanMS2("../rmd/input data format/ft/Pan_052322_X13.FT2", psm1$ScanNumber)
scan1 <- getRealScanFromList(scan1)
```

```{r}
isoCenter <- psm1$MeasuredParentMass / psm1$ParentCharge + 1.007276
anno <- annotatePSM(
  scan1@spectra$MZ, scan1@spectra$Prob,
  scan1@spectra$Charge,
  pep, 1:2, "C13",
  pct, isoCenter, 5.0
)
head(anno$ExpectedBYions[anno$ExpectedBYions$residuePositions != -1, ])
residuePos <- anno$ExpectedBYions$residuePositions[anno$ExpectedBYions$matchedIndices != -1]
table(residuePos)
# let the color be repeatable
set.seed(9527)
plotPSMannotation(
  observedSpect = scan1,
  pep = pep, Atom = "C13", Prob = pct,
  charges = c(1, 2), isoCenter = isoCenter,
  isoWidth = 5, ifRemoveNotFoundIon = T
)
```

#### Plot fragments and precursor

```{r}
# plot observed fragments peaks and theoretical B and Y ion isotopic peaks
BY <- getSipBYionSpectra(pep, Prob = pct, charges = 1:2, precursorCharges = 3)
plot(BY) + plotRealScan(scan1) + plotSipBYionLabel(BY)
```

```{r}
ft1 <- readScansMS1("../rmd/input data format/ft/Pan_052322_X13.FT1", 2000, 2561)
# the nearest ms1 scan to ms2 scan of PSM
precursorScan1 <- getRealScan(2559, ft1)

# plot observed precursor peaks and theoretical precursor isotopic peaks
# precursorSP <- getSipPrecursorSpectra(pep, Prob = 0.012, charges = 3)
precursorSP <- getSipPrecursorSpectra(pep, Prob = 0.5, charges = 3)
precursorSP@spectra$Kind <- "Expected"
xlimit <- precursorScan1@spectra$MZ > 590 & precursorScan1@spectra$MZ < 620
precursorScan1@spectra <- precursorScan1@spectra[xlimit, ]
precursorScan1@spectra$Kind <- "Observed"
maxInt <- max(precursorScan1@spectra$Prob)
precursorScan1@spectra$Prob <- precursorScan1@spectra$Prob / maxInt * 100
plot(precursorSP, linewidth = 0.3) + plotRealScan(precursorScan1, linewidth = 0.3) +
  scale_x_continuous(breaks = seq(590, 620, by = 5))
```

#### Plot PSMs in a batch

```{r eval=FALSE}
psm <- readPSMtsv("../rmd/input data format/pct50.psm.txt")
psm <- psm[psm$Filename=="Pan_052322_X13.FT2",]
psm <- arrange(psm, desc(Score))
psm <- psm[1:10, ]
ft2 <- readAllScanMS2("../rmd/input data format/ft/Pan_052322_X13.FT2")
ftFileNames <- psm$Filename
scanNumbers <- psm$ScanNumber
proNames <- psm$ProteinNames
charges <- psm$ParentCharge
element <- "C13"
pep <- psm$OriginalPeptide
pep <- str_sub(pep, 2, -2)
pct <- psm$SearchName
pct <- as.numeric(str_sub(str_split(pct, "_", simplify = T)[, 2], 1, -4)) / 100 /1000
realScans <- getRealScans(ft2, scanNumbers)
plotPSMs(
  realScans,
  charges,
  element,
  pct,
  BYcharge = 1:2,
  ftFileNames,
  scanNumbers,
  pep,
  proNames,
  "/tmp/"
)
```
